      - name: Configure Windows Firewall and Network
        run: |
          # Set ALL network adapters to Private (CRITICAL for RDP)
          Get-NetAdapter | ForEach-Object {
              $profile = Get-NetConnectionProfile -InterfaceIndex $_.InterfaceIndex
              if ($profile) {
                  Set-NetConnectionProfile -InterfaceIndex $_.InterfaceIndex -NetworkCategory Private
              }
          }
          
          # Enable ALL RDP firewall rules (not just one)
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Enable-NetFirewallRule -Name "RemoteDesktop-UserMode-In-TCP" -ErrorAction SilentlyContinue
          Enable-NetFirewallRule -Name "RemoteDesktop-UserMode-In-UDP" -ErrorAction SilentlyContinue
          
          # Add explicit rule for Tailscale interface
          New-NetFirewallRule -DisplayName "RDP-Tailscale-All" `
            -Direction Inbound `
            -LocalPort 3389 `
            -Protocol TCP `
            -Action Allow `
            -ErrorAction SilentlyContinue

      - name: Final RDP Configuration
        run: |
          # Double-check registry settings
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          # Restart services
          Restart-Service TermService -Force
          Restart-Service SessionEnv -Force  # Needed for Remote Desktop Services
          
          # Verify RDP is listening
          netstat -an | findstr :3389
